<!doctype html><html lang="pt-BR" dir="ltr"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><title>Construindo uma API RESTful com Laravel - Parte 3</title><meta name="description" content="Web development, front end stuff, tutorials for beginners and more by Rafaell Lycan! "><meta name="google-site-verification" content="epFgX0s_0RM3CdjwFcsewfXzPov2g8s9ZBOLyaIUH-o"/><meta name="robots" content="index, follow"><meta name="HandheldFriendly" content="True" /><meta name="MobileOptimized" content="320" /><meta name="mobile-web-app-capable" content="yes"><link rel="canonical" href="http://localhost:4000/2016/construindo-restful-api-laravel-parte-3/"><link rel="alternate" type="application/rss+xml" title="Hi there, I'm Rafaell" href="http://feeds.feedburner.com/MikeFowler" /><link rel="shortcut icon" href="/assets/img/icons/favicon.ico" type="image/x-icon" /><link rel="author" href="https://plus.google.com/+https://plus.google.com/+RafaellLycan?rel=author"><link rel='dns-prefetch' href='//ajax.googleapis.com' /><link rel='dns-prefetch' href='//fonts.googleapis.com' /><link rel='dns-prefetch' href='//use.fontawesome.com' /><link rel='dns-prefetch' href='//s.gravatar.com' /><link rel='dns-prefetch' href='//s2.getsmartlook.com'><link rel='dns-prefetch' href='//rec.getsmartlook.com'><link rel='preconnect' href='//fonts.googleapis.com' crossorigin /><link rel='preconnect' href='//fonts.gstatic.com' crossorigin><link rel='preconnect' href='//s2.getsmartlook.com' crossorigin><link rel='preconnect' href='//rec.getsmartlook.com' crossorigin> <meta name="twitter:card" content="summary_large_image" /><meta name="twitter:site" content="@RafaellLycan" /><meta name="twitter:title" content="Construindo uma API RESTful com Laravel - Parte 3" /><meta name="twitter:description" content="Web development, front end stuff, tutorials for beginners and more by Rafaell Lycan! " /><meta property="twitter:image:src" content="http://localhost:4000assets/img/posts/laravel-api.jpg"> <meta property="og:title" content="Construindo uma API RESTful com Laravel - Parte 3"><meta property="og:url" content="http://localhost:4000/2016/construindo-restful-api-laravel-parte-3/"><meta property="og:description" content="Web development, front end stuff, tutorials for beginners and more by Rafaell Lycan! "><meta property="og:image" content="http://localhost:4000assets/img/posts/laravel-api.jpg"><meta property="og:type" content="article"><meta property="og:site_name" content="Hi there, I'm Rafaell"><link rel="manifest" href="/manifest.json"><link rel="apple-touch-icon" href="/assets/img/icon-96x96.png"><link rel="icon" sizes="192x192" href="/assets/img/icon-192x192.png"><link rel="shortcut icon" href="/assets/img/icon-192x192.png"><style> @charset "UTF-8"; /** Variables */ /** Colors */ /* * It returns the current percent of a context on a reference using pixels * Thanks Ethan Marcotte */ /* * It returns flexible value using 'target / context' formula. * Returns 'rem' as format. */ /* Breakpoint mixin */ /* * It create the current percent of a context on a reference using pixels * Thanks Ethan Marcotte */ /*! normalize.css v5.0.0 | MIT License | github.com/necolas/normalize.css */ /* Document ========================================================================== */ /** 1. Change the default font family in all browsers (opinionated). 2. Correct the line height in all browsers. 3. Prevent adjustments of font size after orientation changes in IE on Windows Phone and in iOS. */ html { font-family: sans-serif; /* 1 */ line-height: 1.15; /* 2 */ -ms-text-size-adjust: 100%; /* 3 */ -webkit-text-size-adjust: 100%; /* 3 */ } /* Sections ========================================================================== */ /** Remove the margin in all browsers (opinionated). */ body { margin: 0; } /** Add the correct display in IE 9-. */ article, aside, footer, header, nav, section { display: block; } /** Correct the font size and margin on `h1` elements within `section` and `article` contexts in Chrome, Firefox, and Safari. */ h1, .h1 { font-size: 2em; margin: 0.67em 0; } /* Grouping content ========================================================================== */ /** Add the correct display in IE 9-. 1. Add the correct display in IE. */ figcaption, figure, main { /* 1 */ display: block; } /** Add the correct margin in IE 8. */ figure { margin: 1em 40px; } /** 1. Add the correct box sizing in Firefox. 2. Show the overflow in Edge and IE. */ hr { box-sizing: content-box; /* 1 */ height: 0; /* 1 */ overflow: visible; /* 2 */ } /** 1. Correct the inheritance and scaling of font size in all browsers. 2. Correct the odd `em` font sizing in all browsers. */ pre { font-family: monospace, monospace; /* 1 */ font-size: 1em; /* 2 */ } /* Text-level semantics ========================================================================== */ /** 1. Remove the gray background on active links in IE 10. 2. Remove gaps in links underline in iOS 8+ and Safari 8+. */ a { background-color: transparent; /* 1 */ -webkit-text-decoration-skip: objects; /* 2 */ } /** Remove the outline on focused links when they are also active or hovered in all browsers (opinionated). */ a:active, a:hover { outline-width: 0; } /** 1. Remove the bottom border in Firefox 39-. 2. Add the correct text decoration in Chrome, Edge, IE, Opera, and Safari. */ abbr[title] { border-bottom: none; /* 1 */ text-decoration: underline; /* 2 */ text-decoration: underline dotted; /* 2 */ } /** Prevent the duplicate application of `bolder` by the next rule in Safari 6. */ b, strong { font-weight: inherit; } /** Add the correct font weight in Chrome, Edge, and Safari. */ b, strong { font-weight: bolder; } /** 1. Correct the inheritance and scaling of font size in all browsers. 2. Correct the odd `em` font sizing in all browsers. */ code, kbd, samp { font-family: monospace, monospace; /* 1 */ font-size: 1em; /* 2 */ } /** Add the correct font style in Android 4.3-. */ dfn { font-style: italic; } /** Add the correct background and color in IE 9-. */ mark { background-color: #ff0; color: #000; } /** Add the correct font size in all browsers. */ small { font-size: 80%; } /** Prevent `sub` and `sup` elements from affecting the line height in all browsers. */ sub, sup { font-size: 75%; line-height: 0; position: relative; vertical-align: baseline; } sub { bottom: -0.25em; } sup { top: -0.5em; } /* Embedded content ========================================================================== */ /** Add the correct display in IE 9-. */ audio, video { display: inline-block; } /** Add the correct display in iOS 4-7. */ audio:not([controls]) { display: none; height: 0; } /** Remove the border on images inside links in IE 10-. */ img { border-style: none; } /** Hide the overflow in IE. */ svg:not(:root) { overflow: hidden; } /* Forms ========================================================================== */ /** 1. Change the font styles in all browsers (opinionated). 2. Remove the margin in Firefox and Safari. */ button, input, optgroup, select, textarea { font-family: sans-serif; /* 1 */ font-size: 100%; /* 1 */ line-height: 1.15; /* 1 */ margin: 0; /* 2 */ } /** Show the overflow in IE. 1. Show the overflow in Edge. */ button, input { /* 1 */ overflow: visible; } /** Remove the inheritance of text transform in Edge, Firefox, and IE. 1. Remove the inheritance of text transform in Firefox. */ button, select { /* 1 */ text-transform: none; } /** 1. Prevent a WebKit bug where (2) destroys native `audio` and `video` controls in Android 4. 2. Correct the inability to style clickable types in iOS and Safari. */ button, html [type="button"], [type="reset"], [type="submit"] { -webkit-appearance: button; /* 2 */ } /** Remove the inner border and padding in Firefox. */ button::-moz-focus-inner, [type="button"]::-moz-focus-inner, [type="reset"]::-moz-focus-inner, [type="submit"]::-moz-focus-inner { border-style: none; padding: 0; } /** Restore the focus styles unset by the previous rule. */ button:-moz-focusring, [type="button"]:-moz-focusring, [type="reset"]:-moz-focusring, [type="submit"]:-moz-focusring { outline: 1px dotted ButtonText; } /** Change the border, margin, and padding in all browsers (opinionated). */ fieldset { border: 1px solid #c0c0c0; margin: 0 2px; padding: 0.35em 0.625em 0.75em; } /** 1. Correct the text wrapping in Edge and IE. 2. Correct the color inheritance from `fieldset` elements in IE. 3. Remove the padding so developers are not caught out when they zero out `fieldset` elements in all browsers. */ legend { box-sizing: border-box; /* 1 */ color: inherit; /* 2 */ display: table; /* 1 */ max-width: 100%; /* 1 */ padding: 0; /* 3 */ white-space: normal; /* 1 */ } /** 1. Add the correct display in IE 9-. 2. Add the correct vertical alignment in Chrome, Firefox, and Opera. */ progress { display: inline-block; /* 1 */ vertical-align: baseline; /* 2 */ } /** Remove the default vertical scrollbar in IE. */ textarea { overflow: auto; } /** 1. Add the correct box sizing in IE 10-. 2. Remove the padding in IE 10-. */ [type="checkbox"], [type="radio"] { box-sizing: border-box; /* 1 */ padding: 0; /* 2 */ } /** Correct the cursor style of increment and decrement buttons in Chrome. */ [type="number"]::-webkit-inner-spin-button, [type="number"]::-webkit-outer-spin-button { height: auto; } /** 1. Correct the odd appearance in Chrome and Safari. 2. Correct the outline style in Safari. */ [type="search"] { -webkit-appearance: textfield; /* 1 */ outline-offset: -2px; /* 2 */ } /** Remove the inner padding and cancel buttons in Chrome and Safari on macOS. */ [type="search"]::-webkit-search-cancel-button, [type="search"]::-webkit-search-decoration { -webkit-appearance: none; } /** 1. Correct the inability to style clickable types in iOS and Safari. 2. Change font properties to `inherit` in Safari. */ ::-webkit-file-upload-button { -webkit-appearance: button; /* 1 */ font: inherit; /* 2 */ } /* Interactive ========================================================================== */ /* Add the correct display in IE 9-. 1. Add the correct display in Edge, IE, and Firefox. */ details, menu { display: block; } /* Add the correct display in all browsers. */ summary { display: list-item; } /* Scripting ========================================================================== */ /** Add the correct display in IE 9-. */ canvas { display: inline-block; } /** Add the correct display in IE. */ template { display: none; } /* Hidden ========================================================================== */ /** Add the correct display in IE 10-. */ [hidden] { display: none; } /** Basic styling */ *, *:before, *:after { box-sizing: border-box; } body { font: 1rem/1.8rem "Merriweather", "PT Serif", Georgia, Cambria, "Times New Roman", Times, serif; letter-spacing: 0.01rem; color: #4f5a63; background: #fff; -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility; } /** Images */ img { max-width: 100%; vertical-align: middle; border-radius: 2px; } /** Figures */ figure { width: 100%; margin: 0 auto; position: relative; clear: both; outline: 0; box-sizing: border-box; user-select: auto; z-index: 100; } figure > img { display: block; } figcaption { position: relative; width: 100%; left: 0; top: 0; color: rgba(79, 90, 99, 0.6); outline: 0; text-align: center; font-size: 14px; margin: 10px auto 0; } /** Headings */ h1, .h1, h2, .h2, h3, .h3, h4, .h4, h5, h6 { font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif; line-height: 1.2em; font-weight: 700; } h1, .h1 { font-size: 3rem; letter-spacing: -2px; } h2, .h2 { font-size: 2.25rem; margin-top: 3rem; letter-spacing: -1px; } h3, .h3 { font-size: 1.875rem; } h4, .h4 { font-size: 1.5rem; } @media only screen and (max-width: 768px) { h1, .h1 { font-size: 2.8rem; } h2, .h2 { font-size: 2.2rem; } } @media only screen and (max-width: 480px) { h1, .h1 { font-size: 1.75rem; } h2, .h2 { font-size: 1.5rem; } h3, .h3 { font-size: 1.3rem; } h4, .h4 { font-size: 1.125rem; } } /** Paragraphs */ p { margin: 0 0 1.875rem; } /** Blockquotes */ blockquote { position: relative; margin: 3.125rem 0; padding: 0 2.5em; font-style: italic; font-size: 1.25rem; color: rgba(79, 90, 99, 0.6); letter-spacing: -.01rem; } blockquote:after, blockquote:before { position: absolute; font-size: 4em; color: rgba(0, 0, 0, 0.6); z-index: -1; font-family: 'Droid Serif', georgia, serif; } blockquote:after { content: "”"; right: 0px; } blockquote:before { content: "“"; left: 0px; } blockquote > :last-child { margin-bottom: 0; } /** Horizontal Reference */ hr { box-sizing: content-box; height: 0; display: block; border: 0; text-align: center; margin-top: 50px; margin-bottom: 50px; } hr:before { content: '...'; display: inline-block; margin-left: .6em; color: rgba(79, 90, 99, 0.4); position: relative; top: -30px; font-size: 1.8rem; letter-spacing: .6em; } @media only screen and (max-width: 768px) { hr { margin-top: 30px; margin-bottom: 30px; font-size: 1.25rem; line-height: 1.4; } } /** Code formatting */ pre, code { font-size: 1em; border-radius: 2px; } code { font-family: "Fira Mono", "monaco", "Consolas", "Lucida Console", monospace; font-size: 1rem; letter-spacing: -0.3px; padding: 1px 5px; white-space: normal; } :not(pre) > code { background: #f5f5f5; margin-right: 0.05em; margin-left: 0.05em; padding-right: 5px; padding-left: 5px; white-space: nowrap; } pre { background: #f5f5f5; line-height: 1.35; overflow-x: auto; margin: 1.875rem 0; white-space: pre; word-wrap: normal; -webkit-overflow-scrolling: touch; } pre > code { border-radius: 2px; color: #3d3e44; display: block; outline: none; overflow-x: auto; padding: 1rem; white-space: inherit; } /** Clearfix */ .clearfix:after { content: ""; display: table; clear: both; } /** Hidden */ .hidden { visibility: hidden; display: none; } /** Default list */ .default-list { list-style-type: none; margin: 0; padding: 0; } /** Image rounded */ .img-rounded { border-radius: 50%; } /** Center */ .center { margin-left: auto; margin-right: auto; } .text-center { text-align: center !important; } .text-light { font-weight: normal; } .text-base-color { color: #0074d9; } /** Links */ a { color: #0074d9; text-decoration: none; transition: all 300ms ease-in-out; } a:hover { color: #0059a6; } a:active, a:hover { text-decoration: underline; outline: 0; } .animate { animation: fade-in-down 600ms; animation-delay: 200ms; } @-webkit-keyframes fade-in-down { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } } @-moz-keyframes fade-in-down { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } } @-ms-keyframes fade-in-down { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } } @-o-keyframes fade-in-down { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } } @keyframes fade-in-down { 0% { opacity: 0; transform: translateY(-10px); } 100% { opacity: 1; transform: translateY(0); } } @-webkit-keyframes fade { 0% { opacity: 0; } 60% { opacity: 0; } 100% { opacity: 1; } } @-moz-keyframes fade { 0% { opacity: 0; } 60% { opacity: 0; } 100% { opacity: 1; } } @-ms-keyframes fade { 0% { opacity: 0; } 60% { opacity: 0; } 100% { opacity: 1; } } @-o-keyframes fade { 0% { opacity: 0; } 60% { opacity: 0; } 100% { opacity: 1; } } @keyframes fade { 0% { opacity: 0; } 60% { opacity: 0; } 100% { opacity: 1; } } .header { width: 100%; margin-bottom: 3.75rem; } .header .author { margin: 0 auto; max-width: 45rem; padding-left: 0; padding-right: 0; border: none; animation: fade 600ms ease; } .header img { min-width: 120px; } .header p { color: inherit; } @media only screen and (max-width: 30rem) { .header p { display: none; } } .nav { position: relative; width: 100%; text-align: center; background-color: #1d2637; font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif; } .nav__brand { font-weight: 700; } @media only screen and (min-width: 48rem) { .nav__brand { position: absolute; top: 0; left: 0; } } @media only screen and (min-width: 48rem) { .nav__github { position: absolute; top: 0; right: 0; } } .nav__list { max-width: 45rem; margin: 0 auto; padding: 0; list-style: none; overflow: hidden; animation: fade 600ms ease; } .nav__item { float: left; width: 33.33%; } .nav a { display: block; padding: 0.625rem 1.875rem; font-size: 13px; color: #E2E6E7; text-decoration: none; text-transform: uppercase; letter-spacing: 1.2px; transition: all 300ms ease-in-out; } .nav a:hover { color: #0d8eff; } .nav svg { vertical-align: bottom; width: 32px; height: 32px; fill: #fff; } .main-nav { position: relative; padding: 35px 40px; margin: 0 0 30px 0; } .main-nav.overlay { position: absolute; top: 0; left: 0; right: 0; height: 70px; border: none; } .split-layout__sidebar { position: relative; display: flex; padding: 1.875rem; background: #1d2637; background: url("../svgs/bg-triangles-black.svg"); font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif; color: white; text-align: center; flex-direction: column; align-items: center; justify-content: center; } @media only screen and (min-width: 48rem) { .split-layout__sidebar { position: fixed; width: 40%; height: 100%; left: 0; } } @media only screen and (min-width: 60rem) { .split-layout__sidebar { width: 30%; } } .split-layout__avatar { max-width: 120px; } @media only screen and (max-width: 30rem) { .split-layout__avatar { display: none; } } .split-layout__title { font-size: 1.875rem; font-weight: 300; } .split-layout__subtitle { font-size: 0.875rem; margin-top: 0; text-transform: uppercase; opacity: .4; } @media only screen and (max-width: 30rem) { .split-layout__subtitle { padding-bottom: 2rem; } } .split-layout__description { padding: 1.875rem 0 0; } @media only screen and (max-width: 30rem) { .split-layout__description { display: none; } } .split-layout__content { padding-top: 1.875rem; padding-bottom: 1.875rem; } @media only screen and (min-width: 48rem) { .split-layout__content { margin-left: 40%; width: auto; max-width: 100%; } } @media only screen and (min-width: 60rem) { .split-layout__content { margin-left: 30%; } } .split-layout .nav { position: absolute; bottom: 0; } .split-layout .nav__brand, .split-layout .nav__github { display: none; } .split-layout .section-title { display: none; } .split-layout .post-list:before, .split-layout .post-list:after { display: none; }</style><link rel="stylesheet" href="/assets/css/main.css?1493084291212194000"><body> <main class="wrapper"><nav class="nav" role="navigation" itemtype="http://schema.org/SiteNavigationElement" itemscope> <a class="nav__brand" href="http://localhost:4000" title="Hi there, I'm Rafaell"> Rafaell Lycan </a><ul class="nav__list"><li class="nav__item"> <a href="/articles" class="nav__link" itemprop="url">Articles</a><li class="nav__item"> <a href="/projects/" class="nav__link" itemprop="url">Projects</a><li class="nav__item"> <a href="/about/" class="nav__link" itemprop="url">About</a></ul><a class="nav__github" href="https://github.com/rafaell-lycan" title="GitHub" target="github_profile"> <svg viewBox="0 0 512 512"><path d="M256 70.7c-102.6 0-185.9 83.2-185.9 185.9 0 82.1 53.3 151.8 127.1 176.4 9.3 1.7 12.3-4 12.3-8.9V389.4c-51.7 11.3-62.5-21.9-62.5-21.9 -8.4-21.5-20.6-27.2-20.6-27.2 -16.9-11.5 1.3-11.3 1.3-11.3 18.7 1.3 28.5 19.2 28.5 19.2 16.6 28.4 43.5 20.2 54.1 15.4 1.7-12 6.5-20.2 11.8-24.9 -41.3-4.7-84.7-20.6-84.7-91.9 0-20.3 7.3-36.9 19.2-49.9 -1.9-4.7-8.3-23.6 1.8-49.2 0 0 15.6-5 51.1 19.1 14.8-4.1 30.7-6.2 46.5-6.3 15.8 0.1 31.7 2.1 46.6 6.3 35.5-24 51.1-19.1 51.1-19.1 10.1 25.6 3.8 44.5 1.8 49.2 11.9 13 19.1 29.6 19.1 49.9 0 71.4-43.5 87.1-84.9 91.7 6.7 5.8 12.8 17.1 12.8 34.4 0 24.9 0 44.9 0 51 0 4.9 3 10.7 12.4 8.9 73.8-24.6 127-94.3 127-176.4C441.9 153.9 358.6 70.7 256 70.7z"> </path> </svg> </a></nav><article class="post single" itemscope itemtype="http://schema.org/BlogPosting"><header class="post__header container"><figure class="post__image"> <img src="/assets/img/posts/laravel-api.jpg" alt="Construindo uma API RESTful com Laravel - Parte 3" itemprop="thumbnailUrl"></figure><h1 class="post__title" itemprop="name headline"> Construindo uma API RESTful com Laravel - Parte 3</h1><div class="post__meta"> <time datetime="2016-08-16T00:00:00+02:00" itemprop="datePublished"> Aug 16, 2016 </time> <span class="section-spacing"> 4311 words </span> <span> 23 minutes read </span><ul class="meta-tag__list"><li class="meta-tag__item"> <a href="/tags/#laravel">laravel</a><li class="meta-tag__item"> <a href="/tags/#php">php</a></ul></div><div class="post__meta__divider"></div></header><section class="post__content container"><p><a href="2016/construindo-restful-api-laravel-parte-2/">No artigo anterior da série</a> criamos nossas rotas e adicionamos uma verificação básica de autenticação através de <strong>middlewares</strong>, mas enfim a jornada chega ao fim. Vamos trabalhar com <strong>validações</strong>, <strong>autenticação</strong> e tratamento de erros.<p>Nesta parte vamos tocar os seguintes tópicos do roadmap:<ul><li>Autenticação e Sessão<li>Validações e tratamento de erros<li><del>Controle de cache com Redis</del></ul><h2 id="autenticação-e-sessão">Autenticação e Sessão</h2><p>Quando falamos de autenticação e sessão isso pode ser um assunto um tanto trivial para alguns, principalmente se pensarmos em aplicações web classicas, através de <strong>forms de login</strong> e sessão utilizando <strong>cookies</strong>. Mas desta vez estamos falando de uma API, a qual deveria ser <strong>stateless</strong> e com toda comunidação (request/response) simplificada utilizando JSON.<p>Nós vamos utilizar <strong>JWT</strong> <em>(Json Web Token)</em> para a comunicação em nossas rotas privadas, o qual irá conter as informações básicas do usuário que esta pedindo a requisição. Eu não vou explicar em detalhes o que é um JWT, mas você pode ler sobre isso neste artigo sobre <em><a href="2016/autenticacao-jwt-angular-app/">Autenticação com Tokens em uma aplicação AngularJS</a></em> e entender os 3 elementos que formam um JWT válido.<p>Agora que estamos alinhados,vamos instalar o pacote <code class="highlighter-rouge">jwt-auth</code> em nosso <code class="highlighter-rouge">composer.json</code>. Atualize o bloco <code class="highlighter-rouge">require</code> incluindo o novo pacote:<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="o">...</span>

<span class="s2">"require"</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">"php"</span><span class="o">:</span> <span class="s2">"&gt;=5.5.9"</span><span class="p">,</span>
    <span class="s2">"laravel/framework"</span><span class="o">:</span> <span class="s2">"5.1.*"</span><span class="p">,</span>
    <span class="s2">"tymon/jwt-auth"</span><span class="o">:</span> <span class="s2">"0.5.*"</span>
<span class="p">},</span></code></pre></figure><p>Em seguida, vamos atualizar nossos pacotes rodando o comando abaixo:<figure class="highlight"><pre><code class="language-bash" data-lang="bash">composer update</code></pre></figure><p>Agora precisamos atualizar nosso array de providers no arquivo <code class="highlighter-rouge">config/app.php</code>. Procure pelo aray <code class="highlighter-rouge">providers</code> localizado na <strong>linha 111</strong> e adicione a seguinte linha:<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="o">...</span>

<span class="nx">Tymon\JWTAuth\Providers\JWTAuthServiceProvider</span><span class="o">::</span><span class="na">class</span></code></pre></figure><p>Também é necessário adicionar os facedes do pacote <code class="highlighter-rouge">jwt-auth</code> no mesmo arquivo. Procure logo abaixo um array chamado <code class="highlighter-rouge">aliases</code> e adicione essas duas linhas:<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="o">...</span>

<span class="s1">'JWTAuth'</span>   <span class="o">=&gt;</span> <span class="nx">Tymon\JWTAuthFacades\JWTAuth</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
<span class="s1">'JWTFactory'</span> <span class="o">=&gt;</span> <span class="nx">Tymon\JWTAuthFacades\JWTFactory</span><span class="o">::</span><span class="na">class</span></code></pre></figure><p>Por fim, precisamos publicar os arquivos de configuração deste novo pacote. Fazemos isso rodando o comando abaixo:<figure class="highlight"><pre><code class="language-bash" data-lang="bash">php artisan vendor:publish --provider<span class="o">=</span><span class="s2">"Tymon</span><span class="se">\J</span><span class="s2">WTAuth</span><span class="se">\P</span><span class="s2">roviders</span><span class="se">\J</span><span class="s2">WTAuthServiceProvider"</span></code></pre></figure><p>Pronto! Foi criado o arquivo <code class="highlighter-rouge">config/jwt.php</code> que contem as configurações default do <code class="highlighter-rouge">jwt-auth</code>. Vamos gerar uma chave secreta para encriptar/decriptar nossos tokens através do comando abaixo:<figure class="highlight"><pre><code class="language-bash" data-lang="bash">php artisan jwt:generate</code></pre></figure><p>Isso irá gerar um novo valor em <code class="highlighter-rouge">secret</code> onde antes se encontrava <code class="highlighter-rouge">"changeme"</code> anteriormente. Também precisamos alterar o arquivo model do usuário que por default esta como <code class="highlighter-rouge">App\User</code>, e em nosso caso precisamos altera-lo para <code class="highlighter-rouge">App\Company</code>.<figure class="highlight"><pre><code class="language-bash" data-lang="bash">&lt;?php
<span class="c"># config/jwt.php</span>
...

<span class="s1">'user'</span> <span class="o">=</span>&gt; <span class="s1">'App\Company'</span>,</code></pre></figure><p>Agora já podemos trabalhar com o pacote <code class="highlighter-rouge">jwt-auth</code> e com isso já podemos definir alguns pontos básicos da nossa aplicação como a autenticação em si. Com isso vamos criar um novo controller chamado <code class="highlighter-rouge">AuthController</code> só que desta vez não queremos um <strong>resource controller</strong>, então utilizamos a flag <code class="highlighter-rouge">--plain</code> no final do comando para cria-lo em branco:<figure class="highlight"><pre><code class="language-bash" data-lang="bash">php artisan make:controller AuthController --plain</code></pre></figure><p>Feito isso, vamos adicionar um novo <em>endpoint</em> em nosso grupo prefixado com <code class="highlighter-rouge">api</code> em nosso arquivo de rotas:<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/routes.php
</span><span class="o">...</span>

<span class="nx">Route</span><span class="o">::</span><span class="na">post</span><span class="p">(</span><span class="s1">'auth/login'</span><span class="p">,</span> <span class="s1">'AuthController@authenticate'</span><span class="p">);</span></code></pre></figure><p>Agora sabemos que o <em>endpoint</em> <code class="highlighter-rouge">/api/auth/login</code> através do verbo <code class="highlighter-rouge">POST</code> irá utilizar o método <code class="highlighter-rouge">authenticate</code> do nosso controller, então vamos desenvolve-lo:<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Controllers/AuthController.php
</span>
<span class="k">namespace</span> <span class="nx">App\Http\Controllers</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Http\Request</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">App\Company</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Requests</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">App\Http\Controllers\Controller</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">JWTAuth</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Hash</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AuthController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// Get only email and password from request
</span>      <span class="nv">$credentials</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">only</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">);</span>

      <span class="c1">// Get user by email
</span>      <span class="nv">$company</span> <span class="o">=</span> <span class="nx">Company</span><span class="o">::</span><span class="na">where</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="nv">$credentials</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span><span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>

      <span class="c1">// Validate Company
</span>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$company</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
          <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="s1">'Invalid credentials'</span>
        <span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Validate Password
</span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">Hash</span><span class="o">::</span><span class="na">check</span><span class="p">(</span><span class="nv">$credentials</span><span class="p">[</span><span class="s1">'password'</span><span class="p">],</span> <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">password</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
            <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="s1">'Invalid credentials'</span>
          <span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
      <span class="p">}</span>

      <span class="c1">// Generate Token
</span>      <span class="nv">$token</span> <span class="o">=</span> <span class="nx">JWTAuth</span><span class="o">::</span><span class="na">fromUser</span><span class="p">(</span><span class="nv">$company</span><span class="p">);</span>

      <span class="c1">// Get expiration time
</span>      <span class="nv">$objectToken</span> <span class="o">=</span> <span class="nx">JWTAuth</span><span class="o">::</span><span class="na">setToken</span><span class="p">(</span><span class="nv">$token</span><span class="p">);</span>
      <span class="nv">$expiration</span> <span class="o">=</span> <span class="nx">JWTAuth</span><span class="o">::</span><span class="na">decode</span><span class="p">(</span><span class="nv">$objectToken</span><span class="o">-&gt;</span><span class="na">getToken</span><span class="p">())</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'exp'</span><span class="p">);</span>

      <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
        <span class="s1">'access_token'</span> <span class="o">=&gt;</span> <span class="nv">$token</span><span class="p">,</span>
        <span class="s1">'token_type'</span> <span class="o">=&gt;</span> <span class="s1">'bearer'</span><span class="p">,</span>
        <span class="s1">'expires_in'</span> <span class="o">=&gt;</span> <span class="nx">JWTAuth</span><span class="o">::</span><span class="na">decode</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'exp'</span><span class="p">)</span>
      <span class="p">]);</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>O código acima é bem simples, mas mesmo com os comentários vamos entender o que esta acontecendo passo a passo:<ol><li>Pegamos da nossa requisição apenas <code class="highlighter-rouge">email</code> e <code class="highlighter-rouge">password</code>;<li>Procuramos pela primeira ocorrência no banco de dados onde a empresa tenha o mesmo email;<li>Verificamos se a empresa existe. Caso <code class="highlighter-rouge">null</code> enviamos um *erro** <code class="highlighter-rouge">401</code>;<li>Verificamos se o <code class="highlighter-rouge">password</code> bate com o <strong>Hash</strong> que temos gravado no banco de dados. Caso contrário enviamos um *erro** <code class="highlighter-rouge">401</code>;<li>Geramos o token com o facede <code class="highlighter-rouge">JWTAuth</code> através do método <code class="highlighter-rouge">fromUser</code>;<li>A partir do token gerado, pegamos a expiração no formato <strong>timestamp</strong> <del>através de mágia negra</del>;<li>Retormamo nosso um <strong>JSON</strong> contendo o token e outros valores como a expiração e o tipo do token.</ol><p>Você deve ter percebido queutilizamos o método <code class="highlighter-rouge">fromUser</code> com um objeto do tipo <code class="highlighter-rouge">Company</code> certo? É por isso que fizemos aquela alteração no arquivo de configuração, mas também reparou que este código ainda esta falho pois não verificamos os dois parâmetros de entrada necessários <em>(<code class="highlighter-rouge">email</code> e <code class="highlighter-rouge">password</code>)</em> e ainda geramos um <strong>timestamp</strong> apenas para exibição na resposta.<p>Você realmente não precisa seguir este padrão de resposta que eu coloquei, eu simplesmente segui o padrão do <a href="http://oauth.net/2/">OAuth 2.0</a> baseado na <a href="https://tools.ietf.org/html/rfc6749">RFC 6749</a>, mas nada te impede de retornar apenas o token.<div class="center"><p><img src="/assets/img/posts/laravel-api-postman-autenticate.png" alt="Laravel Postman POST Authenticate" /></div><p>Agora já conseguimos criar nossos tokens, mas e quanto a recupera-los e intercepta-los em nossos requests? Primeiramente eu gostaria de informar que o pacote que escolhemos já resolve esse problema para nós através dos middlewares <code class="highlighter-rouge">jwt.auth</code> e <code class="highlighter-rouge">jwt.refresh</code>, porem vamos precisar configurar nossa model <code class="highlighter-rouge">Company</code> para suportar as implementações do driver de <code class="highlighter-rouge">Auth</code> e modificar o arquivo de configuração em <code class="highlighter-rouge">config/auth.php</code> para utilizar a classe <code class="highlighter-rouge">Company</code> por padrão ao invés de <code class="highlighter-rouge">User</code>:<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># config/auth.php
</span><span class="o">...</span>

<span class="c1">// Original
</span>    <span class="s1">'model'</span> <span class="o">=&gt;</span> <span class="nx">App\User</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>

    <span class="s1">'table'</span> <span class="o">=&gt;</span> <span class="s1">'users'</span><span class="p">,</span>

<span class="c1">// Updated
</span>    <span class="s1">'model'</span> <span class="o">=&gt;</span> <span class="nx">App\Company</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>

    <span class="s1">'table'</span> <span class="o">=&gt;</span> <span class="s1">'companies'</span><span class="p">,</span>
<span class="o">...</span></code></pre></figure><p>Agora vamos adicionar nossos middlewares:<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Kernel.php
</span><span class="o">...</span>

<span class="k">protected</span> <span class="nv">$routeMiddleware</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">'auth'</span> <span class="o">=&gt;</span> <span class="nx">\App\Http\Middleware\Authenticate</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="s1">'auth.basic'</span> <span class="o">=&gt;</span> <span class="nx">\Illuminate\Auth\Middleware\AuthenticateWithBasicAuth</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="s1">'guest'</span> <span class="o">=&gt;</span> <span class="nx">\App\Http\Middleware\RedirectIfAuthenticated</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="s1">'jwt.auth'</span> <span class="o">=&gt;</span> <span class="nx">\Tymon\JWTAuth\Middleware\GetUserFromToken</span><span class="o">::</span><span class="na">class</span><span class="p">,</span>
    <span class="s1">'jwt.refresh'</span> <span class="o">=&gt;</span> <span class="nx">\TymonJWTAuth\Middleware\RefreshToken</span><span class="o">::</span><span class="na">class</span>
<span class="p">];</span>
<span class="o">...</span></code></pre></figure><p>Para evitarmos erros na hora de verificar os tokens, também precisamos <strong>implementar algumas interfaces</strong> em nossa classe <code class="highlighter-rouge">Company</code> e utilizar algumas <strong>traits</strong> que vai ficar desta forma:<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Company.php
</span>
<span class="k">namespace</span> <span class="nx">App</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Illuminate\Database\Eloquent\Model</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Auth\Authenticatable</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Auth\Passwords\CanResetPassword</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Contracts\Auth\Authenticatable</span> <span class="k">as</span> <span class="nx">AuthenticatableContract</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Illuminate\Contracts\Auth\CanResetPassword</span> <span class="k">as</span> <span class="nx">CanResetPasswordContract</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">Company</span> <span class="k">extends</span> <span class="nx">Model</span> <span class="k">implements</span> <span class="nx">AuthenticatableContract</span><span class="p">,</span> <span class="nx">CanResetPasswordContract</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">Authenticatable</span><span class="p">,</span> <span class="nx">CanResetPassword</span><span class="p">;</span>
<span class="o">...</span>
<span class="p">}</span></code></pre></figure><p>Agora vamos substituir nosso middleware <code class="highlighter-rouge">auth</code> por <code class="highlighter-rouge">jwt.auth</code> em ambos os controllers e pronto, já temos nossa implementação feita.<p>Agora falta muito pouco, pois com o token já conseguimos pegar o usuário o que vai nos permitir realizar alguns tratamentos em nossa aplicação.<p>Você pode testar a autenticação das rotas de duas formas, primeiramente adicionando <code class="highlighter-rouge">authorization</code> em sua header de requisição:<figure class="highlight"><pre><code class="language-text" data-lang="text">Authorization: Bearer {token}</code></pre></figure><p>Ou simplesmente adicionar uma query string seguida pelo token no parâmetro <code class="highlighter-rouge">token</code>:<figure class="highlight"><pre><code class="language-text" data-lang="text">http://localhost:8080/api/jobs?token={token}</code></pre></figure><p>Um aviso aos usuários de <strong>Apache</strong>, ele discarta a header <code class="highlighter-rouge">Authorization</code> em todas as requests, dessa forma você será forçado a reescrever a regra de configuração:<figure class="highlight"><pre><code class="language-text" data-lang="text">RewriteEngine On
RewriteCond %{HTTP:Authorization} ^(.*)
RewriteRule .* - [e=HTTP_AUTHORIZATION:%1]</code></pre></figure><h2 id="validações-e-tratamento-de-erros">Validações e tratamento de erros</h2><p>É claro que em questão de segurança e domínio ainda estamos muito longe de algo aceitável, ainda precisamos de validações na criação e atualização de nossos recursos, identificar quem é a empresa que esta criando um novo job ao invés de simplesmente passar o <code class="highlighter-rouge">id</code> e outros pequenos tratamentos.<p>Uma das coisas que eu descobri depois de um ano utilizando Laravel, assim que virou para a versão 5 foi a facilidade de customizar tudo e utilizar como injeção de dependência.<p>Primeiramente você precisa notar que tanto em <code class="highlighter-rouge">store</code> quanto <code class="highlighter-rouge">update</code> utilizamos como injeção o objeto <code class="highlighter-rouge">Request</code>, então o que vamos fazer é criar um tipo de request com validações em nossas estradas, e é claro que vamos utilizar o <strong>artisan</strong> para isso.<figure class="highlight"><pre><code class="language-bash" data-lang="bash">php artisan make:request StoreCompanyRequest

php artisan make:request UpdateCompanyRequest

php artisan make:request JobRequest

php artisan make:request AuthenticateRequest</code></pre></figure><p>Sim você leu corretamente, com isso já podemos adicionar regras customizadas para nossas entradas. Esses arquivos foram criados em <code class="highlighter-rouge">app/Http/Request/</code>, e com isso já podemos respirar aliviados adicionando nossas validações e dormir em paz a noite. :)<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Requests/AuthenticateRequest.php
</span>
<span class="o">...</span>
<span class="k">class</span> <span class="nc">AuthenticateRequest</span> <span class="k">extends</span> <span class="nx">Request</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">authorize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">rules</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span><span class="p">,</span>
            <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Controllers/AuthController.php
</span>
<span class="o">...</span>
<span class="k">use</span> <span class="nx">App\Http\Requests\AuthenticateRequest</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AuthController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">AuthenticateRequest</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>Em tese isso já resolve nosso problema, porem como nossas chamas são Ajax o retorno é sempre 200 seja para sucesso ou erro, o que implica ao exibir as mensagem de erro pois essa é uma forma de <a href="https://laravel.com/docs/5.2/validation#form-request-validation">validar erros de formulário</a> onde conseguimos retornar mensagens de erro para o front, mas infelizmente não funciona com AJAX.<h4 id="validando-models-e-sessão">Validando models e sessão</h4><p>É possível através de um código ligeiramente simples adicionar validadores a nossa aplicação. Veja um exemplo:<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="o">...</span>

<span class="c1">// Validator Method
</span><span class="k">protected</span> <span class="k">function</span> <span class="nf">companyValidator</span><span class="p">(</span><span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">(),</span> <span class="p">[</span>
        <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'required|max:100'</span><span class="p">,</span>
        <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'required|email|unique:companies'</span>
    <span class="p">]);</span>

    <span class="k">return</span> <span class="nv">$validator</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nv">$validator</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">companyValidator</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

  <span class="k">if</span><span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">()</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
          <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Validation Failed'</span><span class="p">,</span>
          <span class="s1">'errors'</span>        <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span>
      <span class="p">],</span> <span class="mi">422</span><span class="p">);</span>
  <span class="p">}</span>
<span class="o">...</span>
<span class="p">}</span></code></pre></figure><p>Com esse pequeno trecho de código já é possível criar uma validação com regras simples em <code class="highlighter-rouge">name</code> e <code class="highlighter-rouge">email</code> e prevenir que eu tente cadastrar algo sem todos os dados necessários.<p>Imagine que podemos tratar isso em nossas requisições <code class="highlighter-rouge">POST</code> e <code class="highlighter-rouge">PUT</code> previnindo assim registros em branco, e quando um erro ocorre, retornamos um JSON formatado com todos os erros e utilizando o status HTTP <code class="highlighter-rouge">422</code> como o retorno a seguir:<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="s2">"message"</span><span class="err">:</span> <span class="s2">"Validation Failed"</span><span class="p">,</span>
  <span class="s2">"errors"</span><span class="err">:</span> <span class="p">{</span>
    <span class="s2">"name"</span><span class="err">:</span> <span class="p">[</span>
      <span class="s2">"The name field is required."</span>
    <span class="p">],</span>
    <span class="s2">"email"</span><span class="err">:</span> <span class="p">[</span>
      <span class="s2">"The email field is required."</span>
    <span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure><p>Gostou? Pois é o Laravel possui esses pequenos serviços como o <code class="highlighter-rouge">Validator</code>, que pode nos ajudar em coisas simples e pontuais. Poderiamos até mesmo realizar validações diretamente em nossas models mas nesse caso vamos expor nossas validações diretamente em nossos controllers, mesmo eu pensando que essa não é a maneira ideal.<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Controllers/AuthController.php
</span>
<span class="k">use</span> <span class="nx">Validator</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">AuthController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>

<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">authenticate</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span> <span class="p">{</span>
      <span class="c1">// TODO: authenticate JWT
</span>      <span class="nv">$credentials</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">only</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="s1">'password'</span><span class="p">);</span>

      <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$credentials</span><span class="p">,</span> <span class="p">[</span>
          <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span><span class="p">,</span>
          <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span>
      <span class="p">]);</span>

      <span class="k">if</span><span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
              <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Invalid credentials'</span><span class="p">,</span>
              <span class="s1">'errors'</span>        <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">()</span>
          <span class="p">],</span> <span class="mi">422</span><span class="p">);</span>
      <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Pronto, já validamos a entrada de autenticação da API. É claro que isso vai depender muito do que queremos validar exatamente, mas para nosso exemplo serve perfeitamente bem.<p>Agora vamos validar o cadastro e a atualização em <code class="highlighter-rouge">CompaniesController</code> em <code class="highlighter-rouge">store</code>, <code class="highlighter-rouge">update</code> e <code class="highlighter-rouge">delete</code>:<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Controllers/CompaniesController.php
</span>
<span class="k">use</span> <span class="nx">Validator</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">CompaniesController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>

<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">middleware</span><span class="p">(</span><span class="s1">'jwt.auth'</span><span class="p">,</span> <span class="p">[</span><span class="s1">'except'</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s1">'index'</span><span class="p">,</span> <span class="s1">'show'</span><span class="p">,</span> <span class="s1">'store'</span><span class="p">]]);</span>
    <span class="p">}</span>
<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>

        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'required|max:100'</span><span class="p">,</span>
            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'required|email|unique:companies'</span><span class="p">,</span>
            <span class="s1">'password'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span><span class="p">,</span>
        <span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Validation Failed'</span><span class="p">,</span>
                <span class="s1">'errors'</span>    <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">()</span>
            <span class="p">],</span> <span class="mi">422</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$company</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Company</span><span class="p">();</span>
        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
        <span class="nv">$password</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">only</span><span class="p">(</span><span class="s1">'password'</span><span class="p">)[</span><span class="s2">"password"</span><span class="p">];</span>
        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nx">Hash</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>
        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$company</span><span class="p">,</span> <span class="mi">201</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$company</span> <span class="o">=</span> <span class="nx">Company</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>

        <span class="c1">// Verify if $company exists
</span>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$company</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Remove email from $data if it doesn't change
</span>        <span class="k">if</span><span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'email'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">email</span> <span class="o">==</span> <span class="nv">$data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">])</span> <span class="p">{</span>
            <span class="nb">unset</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'email'</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s1">'max:100'</span><span class="p">,</span>
            <span class="s1">'email'</span> <span class="o">=&gt;</span> <span class="s1">'email|unique:companies'</span><span class="p">,</span>
        <span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Validation Failed'</span><span class="p">,</span>
                <span class="s1">'errors'</span>    <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">()</span>
            <span class="p">],</span> <span class="mi">422</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">());</span>

        <span class="c1">// Verify if exists a new password on the request
</span>        <span class="k">if</span> <span class="p">(</span><span class="nb">array_key_exists</span><span class="p">(</span><span class="s1">'password'</span><span class="p">,</span> <span class="nv">$data</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">password</span> <span class="o">=</span> <span class="nx">Hash</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">[</span><span class="s1">'password'</span><span class="p">]);</span>
        <span class="p">}</span>

        <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$company</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$company</span> <span class="o">=</span> <span class="nx">Company</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$company</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">\Auth</span><span class="o">::</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">!=</span> <span class="nv">$company</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'You haven\'t permission to delete this entry'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$company</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">(),</span> <span class="mi">204</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>O método <code class="highlighter-rouge">store</code> é bem simples, parecido com o exemplo anterior onde deixamos as 3 entradas como <code class="highlighter-rouge">required</code> e adicionamos uma validação extra em email onde informamos que deve conter o formato de email e também que ele deve ser único, baseado em nossa base em <code class="highlighter-rouge">companies</code>.<p>Já o método <code class="highlighter-rouge">update</code> tivemos que adicionar algumas regras extras como por exemplo verificar se o <code class="highlighter-rouge">email</code> é novo ou é o mesmo que já temos em nosso objeto <code class="highlighter-rouge">$company</code> para evitarmos receber o erro que o email já existe na base e continuar validando emails únicos. Além disso também fazemos a verificação se existe um novo <code class="highlighter-rouge">password</code> na request, e caso existir criamos um <code class="highlighter-rouge">Hash</code> a partir dele e finalmente atualizamos nosso registro.<p>Você também deve ter reparado que deixamos o método <code class="highlighter-rouge">store</code> fora da validação do middleware <code class="highlighter-rouge">jwt.auth</code>, isso acontece porque não vamos estar logados quando criarmos uma empresa, já que precisamos de uma para se logar no sistema.<p>Enquanto isso temos a mesma validação de identidade em <code class="highlighter-rouge">update</code> e <code class="highlighter-rouge">delete</code> que através do objeto <code class="highlighter-rouge">Auth</code> temos todas as informações usuário autenticado via token, e dessa forma verificamos se o registro a ser alterado/removido pertence ao mesmo. Bem simples e funcional.<p>Novamente essa pode não ser a melhor forma de fazer isso, porem eu não encontrei <del>procurei pouco</del> uma forma melhor de realizar essas validações. Poderiamos como eu disse realiza-las diretamente em nossa model, mas isso vai de cada caso e nesse em especifico não julguei necessário.<p>Agora vamos adicionar algumas validações em nosso <code class="highlighter-rouge">JobsController</code>:<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Http/Controllers/JobsController.php
</span>
<span class="k">use</span> <span class="nx">Validator</span><span class="p">;</span>


<span class="k">class</span> <span class="nc">JobsController</span> <span class="k">extends</span> <span class="nx">Controller</span>
<span class="p">{</span>

<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">store</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$data</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">();</span>

        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'required|max:255'</span><span class="p">,</span>
            <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span><span class="p">,</span>
            <span class="s1">'local'</span> <span class="o">=&gt;</span> <span class="s1">'required'</span><span class="p">,</span>
            <span class="s1">'remote'</span> <span class="o">=&gt;</span> <span class="s1">'in:yes,no'</span><span class="p">,</span>
            <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'integer'</span><span class="p">,</span>
        <span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Validation Failed'</span><span class="p">,</span>
                <span class="s1">'errors'</span>    <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">()</span>
            <span class="p">],</span> <span class="mi">422</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$job</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Job</span><span class="p">();</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$data</span><span class="p">);</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">company_id</span> <span class="o">=</span> <span class="nx">\Auth</span><span class="o">::</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$job</span><span class="p">,</span> <span class="mi">201</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">update</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">,</span> <span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$job</span> <span class="o">=</span> <span class="nx">Job</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$job</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">\Auth</span><span class="o">::</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">!=</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">company_id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'You haven\'t permission to change this entry'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$validator</span> <span class="o">=</span> <span class="nx">Validator</span><span class="o">::</span><span class="na">make</span><span class="p">(</span><span class="nv">$data</span><span class="p">,</span> <span class="p">[</span>
            <span class="s1">'title'</span> <span class="o">=&gt;</span> <span class="s1">'max:255'</span><span class="p">,</span>
            <span class="s1">'remote'</span> <span class="o">=&gt;</span> <span class="s1">'in:yes,no'</span><span class="p">,</span>
            <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'integer'</span><span class="p">,</span>
        <span class="p">]);</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">fails</span><span class="p">())</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Validation Failed'</span><span class="p">,</span>
                <span class="s1">'errors'</span>    <span class="o">=&gt;</span> <span class="nv">$validator</span><span class="o">-&gt;</span><span class="na">errors</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">()</span>
            <span class="p">],</span> <span class="mi">422</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">fill</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">());</span>
        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">save</span><span class="p">();</span>

        <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">(</span><span class="nv">$job</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">destroy</span><span class="p">(</span><span class="nv">$id</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$job</span> <span class="o">=</span> <span class="nx">Job</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>

        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$job</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'Record not found'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">\Auth</span><span class="o">::</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">id</span> <span class="o">!=</span> <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">company_id</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'message'</span>   <span class="o">=&gt;</span> <span class="s1">'You haven\'t permission to delete this entry'</span><span class="p">,</span>
            <span class="p">],</span> <span class="mi">401</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$job</span><span class="o">-&gt;</span><span class="na">delete</span><span class="p">();</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Veja que as validações são bem similares as anteriores, contudo, dessa vez adicionamos uma validação do tipo <strong>enum</strong> para <code class="highlighter-rouge">remote</code> e esperamos que o valor de <code class="highlighter-rouge">type</code> seja <strong>integer</strong>.<p>Perceba também que estamos adicionando o <code class="highlighter-rouge">company_id</code> baseado no id do usuário da sessão, o que facilita o relacionamento para nós e ainda adicionamos a simples validação para que apenas a empresa só possa alterar/remover seus proprios jobs.<h4 id="tratando-erros">Tratando erros</h4><p>Fizemos praticamente todas as validações necessárias em nossa API, entretanto faltou uma simples verificação para erros <code class="highlighter-rouge">404</code> quando um recurso não existe e <code class="highlighter-rouge">405</code> para um verbo HTTP não suportado em um determinado endpoint. Para isso vamos alterar o arquivo <code class="highlighter-rouge">Handler.php</code> que é responsável por lidar por quaisquer tipos de <strong>exception</strong> que nossa aplicação possa ter.<figure class="highlight"><pre><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="c1"># app/Exceptions/Handler.php
</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel\Exception\NotFoundHttpException</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel\Exception\MethodNotAllowedHttpException</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Handler</span> <span class="k">extends</span> <span class="nx">ExceptionHandler</span>
<span class="p">{</span>
<span class="o">...</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nx">Exception</span> <span class="nv">$e</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="o">...</span>
        <span class="c1">// Not found exception handler
</span>        <span class="k">if</span><span class="p">(</span><span class="nv">$e</span> <span class="nx">instanceof</span> <span class="nx">NotFoundHttpException</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="s1">'Invalid URI'</span><span class="p">,</span>
                    <span class="s1">'messages'</span> <span class="o">=&gt;</span> <span class="p">[]</span>
                <span class="p">]</span>
            <span class="p">],</span> <span class="mi">404</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Method not allowed exception handler
</span>        <span class="k">if</span><span class="p">(</span><span class="nv">$e</span> <span class="nx">instanceof</span> <span class="nx">MethodNotAllowedHttpException</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">response</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">json</span><span class="p">([</span>
                <span class="s1">'error'</span> <span class="o">=&gt;</span> <span class="p">[</span>
                    <span class="s1">'description'</span> <span class="o">=&gt;</span> <span class="s1">'Method Not Allowed'</span><span class="p">,</span>
                    <span class="s1">'messages'</span> <span class="o">=&gt;</span> <span class="p">[]</span>
                <span class="p">]</span>
            <span class="p">],</span> <span class="mi">405</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">render</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$e</span><span class="p">);</span>
    <span class="p">}</span>
<span class="o">...</span></code></pre></figure><p>Com as verificações <code class="highlighter-rouge">NotFoundHttpException</code> e <code class="highlighter-rouge">MethodNotAllowedHttpException</code> já resolvemos o problema, inclusive a APP já pode ser considerada pronta para produção.<h2 id="update">Update</h2><p>Então cadê a parte Redis? Pois é, depois de algumas horas escrevendo esta parte do artigo eu reparei que não valeria a pena adicionar <strong>redis</strong> ao projeto, já que os registros podem mudar frequentemente (ou não), mas ideia era bem simples, criar um cache para os registros, assim toda vez que os métodos <code class="highlighter-rouge">index</code> e <code class="highlighter-rouge">show</code> fossem chamados, nós iriamos buscar diretamente no cache os dados ao invés de bater no banco de dados. E toda vez que uma nova vaga/empresa fosse adicionada, atualizada ou deletada, nós atualizariamos o cache. Bem simples na verdade.<p>Mas como não quero demorar mais uma semana para escrever esse artigo acho válido deixar em aberto que é possível e dependendo do tamanho do seu projeto é uma boa escolha.</section><footer class="post__footer"><section class="share"><div class="container"><ul class="share__post-list"><li class="share__post-item" data-hint="Share on Facebook"> <a class="share__icon share__icon--facebook" href="https://facebook.com/sharer.php?u=http://localhost:4000/2016/construindo-restful-api-laravel-parte-3/" target="share-facebook" title="Share on Facebook"> <span class="share__text">Like</span></a> </a><li class="share__post-item" data-hint="Share on Twitter"> <a class="share__icon share__icon--twitter" href="https://twitter.com/intent/tweet?text=Construindo uma API RESTful com Laravel - Parte 3&url=http://localhost:4000/2016/construindo-restful-api-laravel-parte-3/&via=RafaellLycan&related=RafaellLycan" target="share-twitter" title="Share on Twitter"> <span class="share__text">Tweet</span></a> </a><li class="share__post-item" data-hint="Share on Google Plus"> <a class="share__icon share__icon--gplus" href="https://plus.google.com/share?url=http://localhost:4000/2016/construindo-restful-api-laravel-parte-3/" target="share-gplus" title="Share on Google Plus"> <span class="share__text">+1</span></a> </a></ul></div></section><section class="related container"><h3 class="related__title">References</h3><ul class="default-list"><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://vimeo.com/17785736" title="Teach a Dog to REST" target="_blank"> <span itemprop="name">Teach a Dog to REST</span> </a><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://github.com/tymondesigns/jwt-auth" title="Tymon/jwt-auth." target="_blank"> <span itemprop="name">Tymon/jwt-auth.</span> </a><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://daylerees.com/trick-validation-within-models/" title="Trick - Validation within models." target="_blank"> <span itemprop="name">Trick - Validation within models.</span> </a><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://laravel.com/docs/5.2/validation" title="Laravel - Validation" target="_blank"> <span itemprop="name">Laravel - Validation</span> </a><li class="related__mention" itemprop="mentions" itemscope itemtype="https://schema.org/Thing"> <a itemprop="url" href="https://www.youtube.com/playlist?list=PLpvpznviFFFJUWlHylwipLLr1iLYs-cft" title="Create REST API using Laravel" target="_blank"> <span itemprop="name">Create REST API using Laravel</span> </a></ul></section><section class="author" itemprop="author"><div class="author__content container" itemscope itemtype="http://schema.org/Person"><div class="author__pic"> <img src="http://gravatar.com/avatar/dd1c977c7a3e384a9cdae3b5ddd9b006?s=150" alt="" itemprop="image" class="img-rounded"></div><div class="author__bio"><h3 class="author__name" itemprop="name">Rafael Almeida</h3><p> A brazilian Front-end Engineer, living in Barcelona. Works with the web, loves photography and beers, and hates seafood. <a href="mailto:" class="email" itemprop="email"></a> <a href="https://twitter.com/RafaellLycan" class="twitter-follow-button" data-show-count="true"></a></div></div></section><a class="next-article " href="/2016/construindo-restful-api-laravel-parte-2/" title="Construindo uma API RESTful com Laravel - Parte 2"> <span class="container"> <span class="next-article__heading">Next article:</span> <span class="next-article__title">Construindo uma API RESTful com Laravel - Parte 2</span> <span class="next-article__description">No artigo anterior da série nós vimos o setup básico da nossa API, mas esta na hora de fazermos mais, esta na hora de configurarmos nossas rotas e finalizar nosso CRUD. </span> <button class="btn btn--outline">Read more &rarr;</button> </span> </a><section class="comments container"><h3 class="comments__title">Comments</h3><div id="disqus_thread"></div></section><script type="text/javascript"> var disqus_loaded = false; function load_disqus(){ disqus_loaded = true; var disqus_shortname = 'rafaelllycan'; var disqus_title = ''; var disqus_url = '/2016/construindo-restful-api-laravel-parte-3/'; var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); var ldr = document.getElementById('disqus_loader'); }; window.onscroll = function(e) { if ((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 600)) { if (!disqus_loaded) load_disqus(); } }; </script> </footer></article></main><footer class="footer" role="contentinfo"><div class="footer__content"> <span class="footer__copy">&copy; 2017 - Rafaell Lycan</span> <span class="footer__description">Made with ♥ using <a href="http://jekyllrb.com/">Jekyll</a> - &lt;/&gt; on <a href="https://github.com/rafaell-lycan" title="Hosted on GitHub">GitHub</a> </span><ul class="footer__social default-list"><li> <a href="#"> <i class="fa fa-twitter"></i> <span class="social-text">Twitter</span> </a><li> <a href="#"> <i class="fa fa-linkedin"></i> <span class="social-text">Linkedin</span> </a><li> <a href="#"> <i class="fa fa-github"></i> <span class="social-text">Github</span> </a></ul></div></footer> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-16383035-5', 'auto'); ga('require', 'displayfeatures'); ga('send', 'pageview'); </script> <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js?1493084291212194000"></script> <script async src="https://use.fontawesome.com/81e129060e.js?1493084291212194000"></script>  <script src="/assets/scripts/main.js?1493084291212194000"></script> <script> 'use strict'; WebFont.load({ google: { families: [ 'Merriweather:300,300i,900,900i', 'Open Sans: 400,700', 'Fira Mono: 400', ] } }); // if ('serviceWorker' in navigator && (window.location.protocol === 'https:' || window.location.hostname === 'localhost')) { // navigator.serviceWorker // .register('/sw.js?1493084291212194000') // .then(function(registration){console.log('Service Worker Registered.')}) // .catch(function(error){console.log('Error during service worker registration:', error)}); // } </script>
